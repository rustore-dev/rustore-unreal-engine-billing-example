<?xml version="1.0" encoding="utf-8"?>
<root xmlns:android="http://schemas.android.com/apk/res/android">

  <prebuildCopies>
    <copyDir src="$S(PluginDir)/Private/Java" dst="$S(BuildDir)/src/com/Plugins/RuStoreBilling" />
  </prebuildCopies>

  <resourceCopies>
    <copyDir src="$S(PluginDir)/ThirdParty/Android" dst="$S(BuildDir)/libs" />
  </resourceCopies>

  <androidManifestUpdates>
    <loopElements tag="activity">
      <!-- Find UE GameActivity -->
      <log text="Find activity" />
      <setStringFromAttribute result="activityName" tag="$" name="android:name" />
      <setBoolIsEqual result="bUE4GameActivity" arg1="$S(activityName)" arg2="com.epicgames.ue4.GameActivity" />
	    <!-- Add android:exported attribute for UE4 GameActivity -->
	    <if condition="bUE4GameActivity">
		    <true>
			    <addAttribute tag="$" name="android:exported" value="true"/>
		    </true>
	    </if>
      <setBoolIsEqual result="bUE5GameActivity" arg1="$S(activityName)" arg2="com.epicgames.unreal.GameActivity" />
      <setBoolOr result="bGameActivity" arg1="$B(bUE4GameActivity)" arg2="$B(bUE5GameActivity)" />
      <if condition="bGameActivity">
        <true>
          <!-- Add intent-filter to GameActivity -->
          <addElements tag="$">
            <intent-filter>
              <action android:name="android.intent.action.VIEW" />
              <category android:name="android.intent.category.DEFAULT" />
              <category android:name="android.intent.category.BROWSABLE" />
              <!-- Set your appscheme -->
              <data android:scheme="yourappscheme" />
            </intent-filter>
          </addElements>
        </true>
      </if>
    </loopElements>
  </androidManifestUpdates>

  <buildGradleAdditions>
    <insert>
      ext.billing_type = ''
      
      if (project.hasProperty("rustore_sdk_type")) {
        billing_type = rustore_sdk_type
      }
      
      dependencies {
        // RuStore Billing
        if (project.hasProperty('billing_type')) {
          implementation ("ru.rustore.sdk:billingclient:2.1.1$billing_type")
        } else {
          implementation ("ru.rustore.sdk:billingclient:2.1.0")
        }
        implementation fileTree(include: ["RuStoreUnityBillingClient${billing_type}.aar"], dir: 'src/main/libs')
        
        implementation ("androidx.lifecycle:lifecycle-viewmodel:2.5.1")
        implementation ("androidx.lifecycle:lifecycle-viewmodel-ktx:2.5.1")
      }
    </insert>
  </buildGradleAdditions>

  <gameActivityImportAdditions>
    <insert>import ru.rustore.unitysdk.billingclient.RuStoreUnityBillingClient;</insert>
  </gameActivityImportAdditions>

  <gameActivityOnCreateAdditions>
    <insert>
        if (savedInstanceState == null)
        {
            RuStoreUnityBillingClient.onNewIntent(getIntent());
        }</insert>
  </gameActivityOnCreateAdditions>

  <gameActivityOnNewIntentAdditions>
    <insert>
        RuStoreUnityBillingClient.onNewIntent(newIntent);
    </insert>
  </gameActivityOnNewIntentAdditions>
  
  
  
</root>
